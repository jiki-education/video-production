# API Changes for TypeScript Type Generation

**Goal**: Add TypeScript type generation capability to the Rails API repo to serve both `code-videos` and `front-end` frontends.

**Status**: Ready for implementation
**Estimated Time**: 4-5 hours
**Dependencies**: None (this is the foundation for frontend integrations)

---

## Overview

This document outlines the changes needed in the Rails API repo to generate TypeScript types from Rails schemas. The generated types will be consumed by:

1. **code-videos** - Video production pipeline editor
2. **front-end** - Main Jiki learning platform

---

## Directory Structure (After Implementation)

```
api/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ typescript_generator/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generator.rb           # Main generator class
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input_schema_generator.rb  # Generates node input types
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base_generator.rb      # Shared utilities (optional)
‚îÇ   ‚îî‚îÄ‚îÄ tasks/
‚îÇ       ‚îî‚îÄ‚îÄ typescript.rake         # Rake tasks
‚îÇ
‚îú‚îÄ‚îÄ typescript/                     # Generated TypeScript package
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îú‚îÄ‚îÄ .npmignore
‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts               # Main export
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nodes.ts               # Video production node types
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base.ts                # Shared base types
‚îÇ   ‚îî‚îÄ‚îÄ dist/                      # Compiled output (generated)
‚îÇ       ‚îú‚îÄ‚îÄ index.js
‚îÇ       ‚îú‚îÄ‚îÄ index.d.ts
‚îÇ       ‚îú‚îÄ‚îÄ nodes.js
‚îÇ       ‚îú‚îÄ‚îÄ nodes.d.ts
‚îÇ       ‚îú‚îÄ‚îÄ base.js
‚îÇ       ‚îî‚îÄ‚îÄ base.d.ts
‚îÇ
‚îî‚îÄ‚îÄ .gitignore                     # Add typescript/dist/
```

---

## Implementation Steps

### 1. Create TypeScript Package Structure

**Files to create:**

#### `typescript/package.json`

```json
{
  "name": "@jiki/api-types",
  "version": "1.0.0",
  "description": "Auto-generated TypeScript types from Jiki Rails API schemas",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "tsc",
    "clean": "rm -rf dist",
    "prepublishOnly": "pnpm clean && pnpm build"
  },
  "files": ["dist/**/*", "README.md"],
  "keywords": ["jiki", "typescript", "types", "api"],
  "author": "Jiki Team",
  "license": "UNLICENSED",
  "repository": {
    "type": "git",
    "url": "https://github.com/jiki-education/jiki",
    "directory": "typescript"
  },
  "publishConfig": {
    "access": "public"
  },
  "devDependencies": {
    "typescript": "^5.9.0"
  },
  "engines": {
    "node": ">=20.0.0"
  }
}
```

#### `typescript/tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "moduleResolution": "node",
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

#### `typescript/.npmignore`

```
src/
tsconfig.json
*.log
.DS_Store
```

#### `typescript/README.md`

````markdown
# @jiki/api-types

Auto-generated TypeScript types from Jiki Rails API schemas.

**‚ö†Ô∏è DO NOT EDIT FILES IN THIS PACKAGE MANUALLY**

All types are generated from Rails model schemas and constants.

## Usage

### In code-videos

```typescript
import type { TalkingHeadInputs, MergeVideosInputs } from "@jiki/api-types";
```
````

### In front-end

```typescript
import type { User, Course, Lesson } from "@jiki/api-types";
```

## Regenerating Types

```bash
cd api
bundle exec rake typescript:generate
```

## Publishing to npm (optional)

```bash
cd typescript
npm version patch  # or minor/major
npm publish
```

````

#### `typescript/src/index.ts` (initial placeholder)

```typescript
/**
 * @jiki/api-types
 * Auto-generated TypeScript types from Jiki Rails API
 *
 * DO NOT EDIT MANUALLY - Generated by rake typescript:generate
 */

export * from './base';
export * from './nodes';
````

#### `typescript/src/base.ts` (initial placeholder)

```typescript
/**
 * Base types shared across API
 * Generated from Rails schemas
 */

// This file will be populated by the generator
```

#### `typescript/src/nodes.ts` (initial placeholder)

```typescript
/**
 * Video production node types
 * Generated from Rails INPUT_SCHEMAS
 */

// This file will be populated by the generator
```

---

### 2. Create TypeScript Generator

#### `lib/typescript_generator/input_schema_generator.rb`

```ruby
# frozen_string_literal: true

module TypescriptGenerator
  class InputSchemaGenerator
    def initialize(output_dir)
      @output_dir = output_dir
    end

    def generate
      content = <<~TS
        /**
         * Video Production Node Input Types
         * Auto-generated from Rails INPUT_SCHEMAS
         * DO NOT EDIT MANUALLY
         *
         * Generated at: #{Time.current.iso8601}
         * Source: lib/video_production/input_schemas.rb
         */

        #{generate_input_interfaces}
      TS

      write_file('src/nodes.ts', content)
      puts "‚úÖ Generated src/nodes.ts"
    end

    private

    def generate_input_interfaces
      # Import INPUT_SCHEMAS constant
      require_relative '../../app/models/video_production/node'

      schemas = VideoProduction::Node::INPUT_SCHEMAS

      schemas.map do |node_type, inputs|
        generate_interface_for_node(node_type, inputs)
      end.join("\n\n")
    end

    def generate_interface_for_node(node_type, inputs)
      type_name = node_type_to_type_name(node_type)

      # Asset nodes have no inputs
      if inputs.empty?
        return <<~TS.strip
          /** Inputs for #{node_type} nodes (none) */
          export interface #{type_name}Inputs {
            // Asset nodes have no inputs
          }
        TS
      end

      lines = ["/** Inputs for #{node_type} nodes */"]
      lines << "export interface #{type_name}Inputs {"

      inputs.each do |key, schema|
        lines << "  /** #{schema[:description]} */"

        # Determine TypeScript type based on schema
        ts_type = case schema[:type]
                  when :single
                    'string'
                  when :multiple
                    'string[]'
                  else
                    'unknown'
                  end

        # Add optional marker if not required
        optional_marker = schema[:required] ? '' : '?'

        lines << "  #{key}#{optional_marker}: #{ts_type};"
      end

      lines << "}"
      lines.join("\n")
    end

    def node_type_to_type_name(node_type)
      # Convert 'talking-head' -> 'TalkingHead'
      node_type.split('-').map(&:capitalize).join
    end

    def write_file(filename, content)
      path = File.join(@output_dir, filename)
      FileUtils.mkdir_p(File.dirname(path))
      File.write(path, content)
    end
  end
end
```

#### `lib/typescript_generator/generator.rb`

```ruby
# frozen_string_literal: true

require_relative 'input_schema_generator'

module TypescriptGenerator
  class Generator
    def self.generate_all
      output_dir = Rails.root.join('typescript')

      puts "üîß Generating TypeScript types..."
      puts "   Output: #{output_dir}"

      # Generate node input types
      InputSchemaGenerator.new(output_dir).generate

      # Update index.ts with current timestamp
      update_index_file(output_dir)

      # Build TypeScript package
      build_package(output_dir)

      puts "‚ú® TypeScript generation complete!"
    end

    def self.update_index_file(output_dir)
      content = <<~TS
        /**
         * @jiki/api-types
         * Auto-generated TypeScript types from Jiki Rails API
         *
         * DO NOT EDIT MANUALLY - Generated by rake typescript:generate
         * Generated at: #{Time.current.iso8601}
         */

        export * from './base';
        export * from './nodes';
      TS

      File.write(File.join(output_dir, 'src', 'index.ts'), content)
      puts "‚úÖ Updated src/index.ts"
    end

    def self.build_package(output_dir)
      puts "üì¶ Building TypeScript package..."

      Dir.chdir(output_dir) do
        # Install dependencies if needed
        system('pnpm install') unless Dir.exist?('node_modules')

        # Build TypeScript
        result = system('pnpm build')

        if result
          puts "‚úÖ TypeScript build successful"
        else
          puts "‚ùå TypeScript build failed"
          exit 1
        end
      end
    end

    def self.output_dir
      Rails.root.join('typescript')
    end
  end
end
```

---

### 3. Create Rake Tasks

#### `lib/tasks/typescript.rake`

```ruby
# frozen_string_literal: true

namespace :typescript do
  desc "Generate TypeScript types from Rails schemas"
  task generate: :environment do
    require_relative '../typescript_generator/generator'

    TypescriptGenerator::Generator.generate_all
  end

  desc "Clean generated TypeScript files"
  task clean: :environment do
    output_dir = Rails.root.join('typescript', 'dist')

    if Dir.exist?(output_dir)
      FileUtils.rm_rf(output_dir)
      puts "üóëÔ∏è  Cleaned #{output_dir}"
    else
      puts "‚ú® Nothing to clean"
    end
  end

  desc "Publish TypeScript package to npm"
  task publish: :generate do
    output_dir = Rails.root.join('typescript')

    Dir.chdir(output_dir) do
      puts "üì¶ Publishing @jiki/api-types to npm..."

      # Bump version (patch by default)
      system('npm version patch')

      # Publish
      result = system('npm publish')

      if result
        puts "‚úÖ Published to npm!"
      else
        puts "‚ùå Publish failed"
        exit 1
      end
    end
  end
end
```

---

### 4. Update .gitignore

**File**: `.gitignore`

Add:

```gitignore
# TypeScript generated package
typescript/dist/
typescript/node_modules/
typescript/package-lock.json
typescript/pnpm-lock.yaml
typescript/.pnpm-store/
```

**Why**: Don't commit generated build artifacts or dependencies.

---

### 5. Update Gemfile (if needed)

If you need any gems for TypeScript generation:

```ruby
# Gemfile

group :development do
  # For TypeScript generation
  # (Currently none needed - uses pure Ruby)
end
```

---

## Testing the Generator

### Manual Testing

```bash
cd api

# Generate types
bundle exec rake typescript:generate

# Check output
ls -la typescript/src/
ls -la typescript/dist/

# Verify types compile
cd typescript
pnpm install
pnpm build

# Check generated types
cat dist/nodes.d.ts
```

### Expected Output

After running `rake typescript:generate`, you should see:

```
typescript/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ base.ts
‚îÇ   ‚îî‚îÄ‚îÄ nodes.ts
‚îî‚îÄ‚îÄ dist/
    ‚îú‚îÄ‚îÄ index.js
    ‚îú‚îÄ‚îÄ index.d.ts
    ‚îú‚îÄ‚îÄ nodes.js
    ‚îú‚îÄ‚îÄ nodes.d.ts
    ‚îú‚îÄ‚îÄ base.js
    ‚îî‚îÄ‚îÄ base.d.ts
```

**Sample `dist/nodes.d.ts`:**

```typescript
/** Inputs for asset nodes (none) */
export interface AssetInputs {}

/** Inputs for talking-head nodes */
export interface TalkingHeadInputs {
  /** Reference to asset node with script text */
  script?: string;
}

/** Inputs for mix-audio nodes */
export interface MixAudioInputs {
  /** Reference to video node */
  video: string;
  /** Reference to audio node */
  audio: string;
}

/** Inputs for merge-videos nodes */
export interface MergeVideosInputs {
  /** Array of video node references to concatenate */
  segments: string[];
}
```

---

## Validation Checklist

Before merging this PR, verify:

- [ ] `rake typescript:generate` runs without errors
- [ ] Generated TypeScript files have correct syntax
- [ ] `pnpm build` in `typescript/` succeeds
- [ ] `.d.ts` declaration files are created
- [ ] All node types from INPUT_SCHEMAS are present
- [ ] Required vs optional inputs match Rails schema
- [ ] Single vs array types match Rails schema
- [ ] JSDoc comments include descriptions

---

## CI Integration

Add to API repo's CI workflow:

```yaml
# .github/workflows/ci.yml (add this job)

jobs:
  typescript-types:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Generate TypeScript types
        run: bundle exec rake typescript:generate

      - name: Check for uncommitted changes
        run: |
          if [[ -n $(git status -s typescript/src) ]]; then
            echo "‚ùå Generated types differ from committed files"
            echo "Run 'bundle exec rake typescript:generate' and commit changes"
            git diff typescript/src
            exit 1
          fi
```

**Why**: Ensures committed types are always up-to-date with schemas.

---

## Future Enhancements

After initial implementation, consider:

1. **Generate config types** - Add config schema validation to Rails and generate TypeScript types
2. **Generate API response types** - Generate types from Rails serializers
3. **Runtime validation** - Generate Zod schemas alongside TypeScript types
4. **Version management** - Auto-bump package version based on schema changes
5. **Multiple outputs** - Generate separate packages for different API domains

---

## Rollback Plan

If issues arise:

1. Remove `typescript/` directory
2. Remove `lib/typescript_generator/` directory
3. Remove `lib/tasks/typescript.rake`
4. Remove `.gitignore` entries
5. Revert frontend changes (they depend on this)

No database changes - purely code generation.

---

## Related Documents

- `TYPESCRIPT_INTEGRATION_PLAN.md` - Frontend integration for code-videos
- `FRONTEND_INTEGRATION_PLAN.md` - Frontend integration for main app
- `lib/video_production/input_schemas.rb` - Source schemas

---

## Questions & Answers

**Q: Why not use a gem like `typescript-rails`?**
A: We need precise control over the output format and want to generate from our specific INPUT_SCHEMAS constant, not ActiveRecord models.

**Q: Can we generate types for other parts of the API?**
A: Yes! This is the foundation. We can add generators for models, serializers, etc. later.

**Q: What if INPUT_SCHEMAS changes?**
A: Run `rake typescript:generate` and commit the changes. Frontend PRs will automatically pick up the new types via CI.

**Q: Should we commit the generated files?**
A: Yes for `src/`, no for `dist/`. Source files help with code review. Build artifacts are regenerated.

**Q: Can we publish this to npm?**
A: Yes, use `rake typescript:publish`. But for internal development, `file:` dependencies work better.
